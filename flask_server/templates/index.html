<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CrossDaunBot Statistics</title>
        <link rel="stylesheet" href="./static/preflight.css" />
        <link rel="stylesheet" href="./static/style.css" />
    </head>
    <body>
        <div class="container">
            <div class="header-section align-center">
                <div class="header-text">
                    <h2 class="font-32">
                        CrossDaun
                        <span class="text-sky">Users</span>
                    </h2>
                </div>
            </div>
        </div>

        <div class="cards-and-switcher">
            <div class="day-cards">
                <div class="day-card">
                    <div class="day-label">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                    <div class="day-value" id="totalUsers">
                        {{ data.total_msg_count }}
                    </div>
                </div>
                <div class="day-card">
                    <div class="day-label">–°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                    <div class="day-value" id="newToday">
                        {{ data.day_msg_count }}
                    </div>
                </div>
                <div class="day-card day-grid day-username">
                    <div class="day-label">–¢–æ–ø –º–µ—Å—è—Ü–∞</div>
                    <img
                        class="day-avatar bordered"
                        src="{{ data.month_user.avatar if data.month_user else 'https://ui-avatars.com/api/?name=?' }}" />
                    <div class="day-value text-blue" id="activeToday">
                        @{{data.month_user.username_plain if data.month_user
                        else "N/A"}}
                    </div>
                </div>
            </div>
            <div class="align-right search-section">
                <input
                    type="text"
                    id="searchInput"
                    class="search-box"
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." />
            </div>
            <div class="switcher-box">
                <button id="alltime" class="switcher active">
                    –ó–∞ –≤—Å–µ –≤—Ä–µ–º—è
                </button>
                <button id="allmonth" class="switcher">–ó–∞ –º–µ—Å—è—Ü</button>
            </div>
            <div class="cards">
                <div class="table-header grid-row">
                    <div>
                        <span onclick="sortTable(0)" class="text-sky white-born"
                            >ID</span
                        >
                    </div>
                    <div>
                        <span
                            onclick="sortTable(1)"
                            class="text-sky not-in-mobile"
                            >–§–æ—Ç–æ</span
                        >
                    </div>
                    <div>
                        <span onclick="sortTable(2)" class="text-sky white-born"
                            >–ò–º—è</span
                        >
                    </div>
                    <div class="align-center">
                        <span onclick="sortTable(3)" class="text-sky white-born"
                            >–°–æ–æ–±—â–µ–Ω–∏–π</span
                        >
                    </div>
                    <div class="align-center">
                        <span onclick="sortTable(4)" class="text-sky white-born"
                            >–ú–µ–¥–∏–∞</span
                        >
                    </div>
                    <div class="align-center">
                        <span onclick="sortTable(5)" class="text-sky white-born"
                            >–°—Ç–∏–∫–µ—Ä–æ–≤</span
                        >
                    </div>
                    <div class="align-center">
                        <span onclick="sortTable(6)" class="text-sky white-born"
                            >nya</span
                        >
                    </div>
                </div>
                {% for user in data.users %}
                <div class="card grid-row">
                    <div class="ID filterable sortable">
                        <span>{{ user.id }}</span>
                    </div>
                    <img class="avatar" src="{{ user.avatar }}" />
                    <span
                        class="user-info-mobile user-name text-blue filterable sortable"
                        >@{{ user.username_plain }}</span
                    >
                    <div class="align-center msg sortable">
                        <div class="split-box">
                            <span
                                class="val-to-update"
                                data-alltime="üí¨ {{ user.msg_count }}"
                                data-month="üí¨ {{ user.msg_count_month }}"></span>
                        </div>
                    </div>
                    <div class="align-center media sortable">
                        <div class="split-box">
                            <span
                                class="split-val val-to-update"
                                data-alltime="üñºÔ∏è {{ user.photo_count }}"
                                data-month="üñºÔ∏è {{ user.photo_count_month }}"></span>
                            <div class="seperator"></div>
                            <span
                                class="split-val val-to-update"
                                data-alltime="üé• {{ user.video_count }}"
                                data-month="üé• {{ user.video_count_month }}"></span>
                        </div>
                    </div>
                    <div class="align-center stickers sortable">
                        <div class="split-box">
                            <span
                                class="val-to-update"
                                data-alltime="üí† {{ user.sticker_count }}"
                                data-month="üí† {{ user.sticker_count_month }}"></span>
                        </div>
                    </div>
                    <div class="align-center nya sortable">
                        <div class="split-box">
                            <span
                                class="val-to-update"
                                data-alltime="üê± {{ user.nya_count }}"
                                data-month="üê± {{ user.nya_count_month }}"></span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <script>
            // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener("DOMContentLoaded", () => {
                // --- 1. –ü–æ–∏—Å–∫ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è) ---
                document
                    .getElementById("searchInput")
                    .addEventListener("input", function () {
                        const filter = this.value.toLowerCase();
                        const cards = document.querySelectorAll(".cards .card");

                        cards.forEach((card) => {
                            const searchableElements =
                                card.querySelectorAll(".filterable");
                            const matches = Array.from(searchableElements).some(
                                (el) =>
                                    el.textContent
                                        .toLowerCase()
                                        .includes(filter),
                            );
                            card.style.display = matches ? "" : "none";
                        });
                    });

                // --- 2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ---
                let sortDirections = {};
                window.sortTable = function (columnIndex) {
                    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è onclick
                    const container = document.querySelector(".cards");
                    const cards = Array.from(
                        container.querySelectorAll(".card"),
                    );

                    sortDirections[columnIndex] = !sortDirections[columnIndex];
                    const isAsc = sortDirections[columnIndex];

                    cards.sort((a, b) => {
                        let valA = a.children[columnIndex].textContent.trim();
                        let valB = b.children[columnIndex].textContent.trim();

                        if (columnIndex !== 2) {
                            valA = parseInt(valA.replace(/\D/g, "")) || 0;
                            valB = parseInt(valB.replace(/\D/g, "")) || 0;
                            return isAsc ? valA - valB : valB - valA;
                        }
                        return isAsc
                            ? valA.localeCompare(valB)
                            : valB.localeCompare(valA);
                    });

                    cards.forEach((card) => container.appendChild(card));
                };

                // --- 3. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–µ—Ä–∏–æ–¥–æ–≤ –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
                const switchButtons = document.querySelectorAll(".switcher");
                const valuesToUpdate =
                    document.querySelectorAll(".val-to-update");

                // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                function updatePeriod(periodType) {
                    valuesToUpdate.forEach((el) => {
                        const newValue = el.getAttribute(`data-${periodType}`);
                        if (newValue) {
                            el.textContent = newValue;
                        }
                    });
                }

                switchButtons.forEach((btn) => {
                    btn.addEventListener("click", function () {
                        switchButtons.forEach((b) =>
                            b.classList.remove("active"),
                        );
                        this.classList.add("active");

                        const period =
                            this.id === "alltime" ? "alltime" : "month";
                        updatePeriod(period);
                    });
                });
                updatePeriod("alltime");
            });
        </script>
    </body>
</html>
